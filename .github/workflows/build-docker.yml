name: Build remote / local with docker

on:
  push:
  workflow_dispatch:

# https://github.com/dorny/paths-filter?tab=readme-ov-file#example
# https://github.com/vtnerd/monero-lws/blob/master/.github/workflows/docker-build.yml
jobs:
  dockerbuild:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      discussions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with: 
          submodules: recursive
          fetch-depth: 0

      - name: Check if we rebuild + push docker image
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            src:
              - 'Dockerfile'
              - 'submodules/mktorrent/**'
              - 'create_monero_torrent.sh'

      - name: Install transmission-cli
        run: |
          sudo apt-get install -y transmission-cli

      - name: get version from hashes.txt
        id: hashes_version
        run: |
          HASHES_URL="https://www.getmonero.org/downloads/hashes.txt"
          curl -sL $HASHES_URL -o hashes.txt
          version=$(awk '/monero-source-v/ {print $2}' "hashes.txt" | awk -F".tar.bz2" '{print $1}' | awk -F"-" '{print $3}') 
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "VERSION=$version" >> $GITHUB_ENV

      - uses: actions/cache@v4
        id: binaries_cache
        if: "!startsWith(github.ref, 'refs/tags/v')"
        with:
          path: ./downloads
          key: monero-binaries-${{ steps.hashes_version.outputs.version }}

      - name: ghcr login
        if: steps.changes.outputs.src == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run remote profile
        run: |
          if [ "${{ steps.changes.outputs.src }}" = "true" ]; then
            # force rebuild instead of pulling container.
            # the local step will use this container.
            docker compose --profile remote up --build
          else
            docker compose --profile remote up
          fi
          MAGNET_LINK=$(transmission-show -m ./watch/*)
          echo "MAGNET_LINK_REMOTE=$MAGNET_LINK" >> $GITHUB_ENV
          sudo rm ./watch/*

      - name: Push new image to ghcr
        if:  github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.changes.outputs.src == 'true'
        run: docker push -a ghcr.io/plowsof/monero-torrent-build-env

      - name: Move downloads to cdn
        run: |
          mkdir -p ./cdn
          sudo mv ./downloads/* ./cdn/

      - name: Run local profile
        run: |
          docker compose --profile local up
          MAGNET_LINK=$(transmission-show -m ./watch/*)
          echo "MAGNET_LINK_LOCAL=$MAGNET_LINK" >> $GITHUB_ENV


      - name: Compare hashes and write summary
        run: |
          if [ "$MAGNET_LINK_REMOTE" = "$MAGNET_LINK_LOCAL" ]; then
            echo "- Magnet links match:    " >> $GITHUB_STEP_SUMMARY
            echo ">$MAGNET_LINK_LOCAL" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Magnet links differ" >> $GITHUB_STEP_SUMMARY
            echo "Remote: $MAGNET_LINK_REMOTE" >> $GITHUB_STEP_SUMMARY
            echo "Local:  $MAGNET_LINK_LOCAL" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: create release notes
        run: |
          {
            echo "### Torrent info"
            echo '```'
            transmission-show watch/*
            echo '```'
            echo "### ðŸ§² Link"
            echo '```'
            transmission-show -m watch/*
            echo '```'
          } >> release-notes.md

      - name: Add release notes to step summary
        run: |
          cat release-notes.md >> $GITHUB_STEP_SUMMARY

      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          body_path: release-notes.md
          files: watch/*

      - name: Add to RSS feed
        if: github.ref_type == 'tag'
        run: |
          git config --local user.email "torrent@users.noreply.github.com"
          git config --local user.name "updateRSS"
          git fetch origin main
          git checkout main
          git rebase origin/main
          git checkout -b update-rss-${VERSION}
          ./rss/add_to_rss.sh
          git add ./rss/torrent-rss.xml
          git commit -m "RSS: add $VERSION"
          git push origin HEAD:update-rss-${VERSION} --force
